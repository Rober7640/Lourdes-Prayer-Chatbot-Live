# AI Architecture Documentation

## Overview

The Lourdes Chatbot uses Claude AI for two distinct flows:
1. **Initial Prayer Flow** — Guided conversation to compose a prayer intention
2. **Upsell 1 Flow** — Post-payment medal offer (mostly scripted, minimal AI)

---

## File Map

```
server/
├── routes.ts                    # API endpoints, orchestrates both flows
└── services/
    ├── claude.ts                # INITIAL FLOW - AI prompts & response handling
    ├── claude-upsell.ts         # UPSELL FLOW - Scripted messages + fallback AI
    ├── session.ts               # Prayer session state management
    └── upsell-session.ts        # Upsell session state management
```

---

## Initial Prayer Flow

### Primary File: `server/services/claude.ts`

**Size:** ~1400 lines
**AI Model:** Claude Sonnet (claude-sonnet-4-20250514)

#### Structure

| Section | Lines | Purpose |
|---------|-------|---------|
| Types | 1-78 | SessionContext, ClaudeResponse, phases |
| Safety Guardrails | 79-120 | Crisis keywords, inappropriate patterns, AI detection |
| Intent Classification | 122-470 | Prayer, Email, Payment intent patterns |
| Welcome Messages | 472-520 | Scripted welcome flow |
| Bucket Acknowledgments | 522-556 | Scripted bucket-specific responses |
| **System Prompt** | 558-650 | Sister Marie persona & rules |
| Phase Instructions | 658-1100 | Deepening, payment, crisis handling |
| Response Generation | 1280-1400 | API call to Claude |

#### Key Functions

```typescript
// Main entry point for chat messages
generateResponse(userMessage: string, context: SessionContext): Promise<ClaudeResponse>

// Builds the system prompt with persona + phase instructions
buildSystemPrompt(context: SessionContext, intents?: IntentContext): string

// Phase-specific prompt additions
getPhaseInstructions(context: SessionContext, intents?: IntentContext): string

// Scripted (non-AI) responses
getWelcomeMessages(): { messages: string[], uiHint: string }
getBucketAcknowledgment(bucket: BucketType, userName?: string): { messages: string[], uiHint: string }

// Intent classifiers (pattern matching, no AI)
classifyPrayerIntent(message: string, subPhase: PrayerSubPhase): PrayerIntent
classifyEmailIntent(message: string): EmailIntent
classifyPaymentIntent(message: string): PaymentIntent
```

#### System Prompt Location

**Lines 558-650** contain the core Sister Marie persona:

```typescript
function buildSystemPrompt(context: SessionContext, intents?: IntentContext): string {
  const basePrompt = `You are Messenger Marie, a warm and pastoral guide...

  ## ABSOLUTE RULES (NEVER VIOLATE)
  1. You are HUMAN. Never admit to being AI/bot/program.
  ...

  ## RESPONSE FORMAT
  Always return valid JSON with this structure:
  ...

  ## VOICE & TONE
  - Warm, unhurried, genuinely caring
  ...
```

#### Phase Instructions Location

**Lines 658-1100** contain phase-specific prompts appended to base:

- `case "welcome":` — Name capture instructions
- `case "bucket_selection":` — Bucket selection handling
- `case "deepening":` — Main conversation flow (email → name → situation → prayer)
- `case "payment":` — Payment transition

---

## Upsell 1 Flow

### Primary File: `server/services/claude-upsell.ts`

**Size:** ~760 lines
**AI Model:** Claude Sonnet (only for free-form fallback)

#### Key Difference from Initial Flow

**Upsell is 95% scripted.** Messages are hardcoded by phase, not generated by AI.
AI is only used as fallback for unexpected free-form user messages.

#### Structure

| Section | Lines | Purpose |
|---------|-------|---------|
| Types & Imports | 1-14 | UpsellResponse, phases |
| Scripted Messages | 34-485 | All phase messages (transition → the_ask) |
| Action Handlers | 490-600 | Button click responses |
| Phase Advancement | 603-672 | Auto-advance logic |
| AI Fallback | 682-760 | Claude call for unexpected messages |

#### Key Functions

```typescript
// Scripted message getters (no AI)
getTransitionMessages(ctx): ScriptedMessage
getIntroductionMessages(ctx): ScriptedMessage
getShowFrontMessages(ctx): ScriptedMessage
getBernadetteStoryMessages(): ScriptedMessage
getWaterRevealMessages(ctx): ScriptedMessage
getSocialProofMessages(ctx): ScriptedMessage
getTheGivingMessages(ctx): ScriptedMessage
getTheAskMessages(ctx): ScriptedMessage
getAcceptanceMessages(ctx): ScriptedMessage
getTellMeMoreMessages(ctx): ScriptedMessage
getDownsellMessages(ctx): ScriptedMessage
getCandleAcceptanceMessages(ctx): ScriptedMessage
getCandleDeclineMessages(ctx): ScriptedMessage
getEarlyExitMessages(ctx): ScriptedMessage

// Entry points
getInitialUpsellMessages(ctx): UpsellResponse  // First load
handleUpsellAction(ctx, action): UpsellResponse  // Button clicks
advanceUpsellPhase(ctx): UpsellResponse  // Auto-advance

// AI fallback (rarely used)
handleUpsellMessage(ctx, userMessage): Promise<UpsellResponse>
```

#### AI Fallback Location

**Lines 682-760** contain the fallback AI handler:

```typescript
export async function handleUpsellMessage(
  ctx: UpsellSessionContext,
  userMessage: string
): Promise<UpsellResponse> {
  const systemPrompt = `You are Messenger Marie, continuing a conversation about the Lourdes Healing Medal.

  CONTEXT:
  - User name: ${ctx.userName || "friend"}
  - Person they're praying for: ${ctx.personName || "their loved one"}
  ...

  RULES:
  1. Be warm, pastoral, unhurried
  2. Never pressure or guilt
  3. Accept "no" gracefully
  ...
```

---

## Session State Files

### `server/services/session.ts`
Manages prayer session state (in-memory + database persistence):
- createSession, getSession, updateSession
- setBucket, updateExtracted, setReadyForPayment
- Conversation history management

### `server/services/upsell-session.ts`
Manages upsell session state (in-memory only):
- createUpsellSession, getUpsellSession
- setUpsellPhase, setUpsellFlag, setPurchaseType
- Links to original prayer session via sessionId

---

## API Endpoints

### Initial Flow (routes.ts)

| Endpoint | Handler | AI Used? |
|----------|---------|----------|
| `POST /api/chat/start` | Creates session, returns welcome | No (scripted) |
| `POST /api/chat/bucket` | Handles bucket selection | No (scripted) |
| `POST /api/chat/email` | Captures email | No (scripted follow-up) |
| `POST /api/chat/message` | Main chat | **Yes** (`generateResponse`) |
| `POST /api/chat/payment-ready` | Transitions to payment | No (scripted) |

### Upsell Flow (routes.ts)

| Endpoint | Handler | AI Used? |
|----------|---------|----------|
| `GET /api/confirmation/:id` | Loads upsell page | No (scripted) |
| `POST /api/upsell/action` | Button clicks | No (scripted) |
| `POST /api/upsell/advance` | Auto-advance phases | No (scripted) |
| `POST /api/upsell/message` | Free-form text | **Yes** (fallback only) |
| `POST /api/upsell/medal` | Medal purchase | No |
| `POST /api/upsell/candle` | Candle purchase | No |

---

## Content Locations Quick Reference

### To Edit Sister Marie's Voice/Rules
→ `claude.ts` lines 558-650 (basePrompt in `buildSystemPrompt`)

### To Edit Prayer Composition Instructions
→ `claude.ts` lines 753-900 (in `getPhaseInstructions`, case "deepening")

### To Edit Bucket-Specific Guidance
→ `claude.ts` function `getBucketGuidance()` (~lines 470-530)

### To Edit Upsell Scripted Messages
→ `claude-upsell.ts` lines 34-485 (each `get*Messages` function)

### To Edit Safety Keywords
→ `claude.ts` lines 83-120 (CRISIS_KEYWORDS, INAPPROPRIATE_PATTERNS)

### To Edit Intent Patterns
→ `claude.ts` lines 147-470 (PRAYER_INTENT_PATTERNS, EMAIL_INTENT_PATTERNS, etc.)

---

## Future Refactor Suggestion

Current monolithic structure could be split:

```
server/services/
├── claude/
│   ├── client.ts           # Anthropic API client
│   ├── response-parser.ts  # JSON extraction & validation
│   └── index.ts            # Main generateResponse()
├── prompts/
│   ├── persona.ts          # Sister Marie base prompt
│   ├── phases/
│   │   ├── welcome.ts
│   │   ├── deepening.ts
│   │   └── payment.ts
│   └── buckets.ts          # Bucket-specific guidance
├── intents/
│   ├── prayer.ts           # Prayer intent classification
│   ├── email.ts            # Email intent classification
│   └── payment.ts          # Payment intent classification
├── safety/
│   ├── crisis.ts           # Crisis detection
│   └── guardrails.ts       # Content filtering
└── upsell/
    ├── messages.ts         # Scripted upsell messages
    └── fallback.ts         # AI fallback handler
```

### Why Refactor?

#### Problem 1: Copy Changes Require Developer

**Now:** Marketing wants to tweak Sister Marie's tone or test new prayer wording.
→ Developer must edit `claude.ts`, find the right spot in 1400 lines, deploy.

**After refactor:** `prompts/persona.ts` is a standalone file with just the copy.
→ Non-engineer can edit, PR is obvious (only copy changed, no logic risk).

---

#### Problem 2: A/B Testing is Hard

**Now:** Want to test two different "The Ask" messages in upsell?
→ Add conditionals inside `claude-upsell.ts`, messy, hard to remove later.

**After refactor:**
```typescript
// prompts/upsell/the-ask-v1.ts
export const theAskMessages = [...]

// prompts/upsell/the-ask-v2.ts
export const theAskMessages = [...]

// Load based on experiment flag
import { theAskMessages } from session.experiment === 'v2'
  ? './the-ask-v2'
  : './the-ask-v1';
```

---

#### Problem 3: Git History is Noisy

**Now:** One commit touches `claude.ts`:
- "Fixed typo in Bernadette story"
- "Added new intent pattern"
- "Changed API timeout"

All look the same in git blame. Hard to track what actually changed.

**After refactor:**
- `prompts/bernadette.ts` — copy changes only
- `intents/prayer.ts` — pattern changes only
- `claude/client.ts` — API changes only

---

#### Problem 4: Testing is All-or-Nothing

**Now:** To test intent classification, you need to mock the entire Claude response flow.

**After refactor:**
```typescript
// intents/prayer.test.ts
import { classifyPrayerIntent } from './prayer';

test('detects confirmation', () => {
  expect(classifyPrayerIntent('yes perfect', 'awaiting_confirm')).toBe('confirm');
});
```
Pure function, no mocking needed.

---

#### Problem 5: Onboarding is Slow

**Now:** New dev needs to understand 1400 lines to make any change.

**After refactor:** Clear boundaries:
- "I need to change the crisis keywords" → `safety/crisis.ts`
- "I need to add a new bucket" → `prompts/buckets.ts`
- "I need to fix intent detection" → `intents/prayer.ts`

---

### Benefits Summary

| Benefit | Impact |
|---------|--------|
| **Non-dev editable copy** | Marketing/product can tweak messaging |
| **A/B testing** | Swap prompt files without touching logic |
| **Clean git history** | Know exactly what changed and why |
| **Unit testable** | Test intent patterns in isolation |
| **Faster onboarding** | New devs find things quickly |
| **Reduced risk** | Copy change can't break API logic |

---

### When To Do It

**After conversation flow is stable.** Refactoring now while flow is changing = wasted effort.
